<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Perpustakaan AI Online Plus Tema</title>
<style>
body { font-family: Arial; text-align: center; padding: 20px; background: #fff8dc; }
h1 { color: #2e8b57; }
button { padding: 15px; margin: 8px; font-size: 18px; width: 80%; max-width: 300px; border-radius: 15px; border: none; background-color: #2e8b57; color: white; cursor: pointer; box-shadow: 2px 2px 5px rgba(0,0,0,0.2);}
button:hover { background-color: #3cb371; }
input, textarea { width: 80%; padding: 10px; margin: 5px; border-radius: 10px; border: 1px solid #ccc; max-width: 400px; }
#reader { width: 300px; margin: 20px auto; }
#output { margin-top: 20px; font-size: 18px; }
#progress { margin-top: 10px; font-weight: bold; color: #d2691e; }
</style>
</head>
<body>

<h1>üìö Perpustakaan AI Online Plus + Tema</h1>

<div id="menu">
  <button onclick="showScan()">üì∑ Scan ISBN</button>
  <button onclick="showManualISBN()">‚å®Ô∏è Input ISBN Manual</button>
  <button onclick="showJudulPengarang()">üìù Input Judul & Pengarang</button>
  <button onclick="showDaftarBuku()">üìñ Multi-Buku</button>
</div>

<div id="reader"></div>
<div id="output"></div>
<div id="progress"></div>

<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>

<script>
let bukuQueue = [];

// ------------------- SCAN ISBN -------------------
function showScan() {
  document.getElementById("menu").style.display = "none";
  document.getElementById("output").innerHTML = "Membuka kamera untuk scan barcode...";
  const html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    (decodedText) => {
      html5QrCode.stop();
      document.getElementById("reader").innerHTML = "";
      cariBukuOnline(decodedText);
    },
    (errorMessage) => {}
  );
}

// ------------------- INPUT ISBN MANUAL -------------------
function showManualISBN() {
  document.getElementById("menu").style.display = "none";
  document.getElementById("output").innerHTML = `
    <h2>Masukkan ISBN Buku</h2>
    <input type="text" id="isbnManual" placeholder="Contoh: 9781234567890"><br>
    <button onclick="cariBukuManual()">Cari & Preview</button>
    <button onclick="kembaliMenu()">üè† Kembali</button>
  `;
}

function cariBukuManual() {
  const isbn = document.getElementById("isbnManual").value.trim();
  if(!isbn){ alert("Masukkan ISBN!"); return; }
  cariBukuOnline(isbn);
}

// ------------------- INPUT JUDUL & PENGARANG -------------------
function showJudulPengarang() {
  document.getElementById("menu").style.display = "none";
  document.getElementById("output").innerHTML = `
    <h2>Masukkan Judul & Pengarang Buku</h2>
    <input type="text" id="judulBuku" placeholder="Judul Buku"><br>
    <input type="text" id="pengarangBuku" placeholder="Pengarang"><br>
    <button onclick="cariBukuJudulPengarang()">Cari & Preview</button>
    <button onclick="kembaliMenu()">üè† Kembali</button>
  `;
}

async function cariBukuJudulPengarang() {
  const judul = document.getElementById("judulBuku").value.trim();
  const pengarang = document.getElementById("pengarangBuku").value.trim();
  if(!judul && !pengarang){ alert("Masukkan minimal judul atau pengarang!"); return; }

  document.getElementById("output").innerHTML = "Mencari buku di internet...";
  try {
    const query = `intitle:${encodeURIComponent(judul)}+inauthor:${encodeURIComponent(pengarang)}`;
    const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${query}`);
    const data = await response.json();

    if(data.totalItems > 0){
      const bukuInfo = data.items[0].volumeInfo;
      const j = bukuInfo.title || "Judul tidak tersedia";
      const p = bukuInfo.authors ? bukuInfo.authors.join(", ") : "Pengarang tidak tersedia";
      const deskripsi = bukuInfo.description || "Ringkasan buku tidak tersedia, AI akan menceritakan secara umum.";
      previewBuku(`${j} (oleh ${p})`, deskripsi);
    } else {
      document.getElementById("output").innerHTML = `Buku tidak ditemukan.<br><button onclick='kembaliMenu()'>üè† Kembali</button>`;
    }
  } catch(err){
    document.getElementById("output").innerHTML = `Terjadi kesalahan saat mencari buku.<br><button onclick='kembaliMenu()'>üè† Kembali</button>`;
    console.error(err);
  }
}

// ------------------- CARI BUKU DARI ISBN -------------------
async function cariBukuOnline(isbn) {
  document.getElementById("output").innerHTML = "Mencari buku di internet...";
  try {
    const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`);
    const data = await response.json();
    if(data.totalItems > 0){
      const bukuInfo = data.items[0].volumeInfo;
      const judul = bukuInfo.title || "Judul tidak tersedia";
      const pengarang = bukuInfo.authors ? bukuInfo.authors.join(", ") : "Pengarang tidak tersedia";
      const deskripsi = bukuInfo.description || "Ringkasan buku tidak tersedia, AI akan menceritakan secara umum.";
      previewBuku(`${judul} (oleh ${pengarang})`, deskripsi);
    } else {
      document.getElementById("output").innerHTML = `Buku tidak ditemukan.<br><button onclick='kembaliMenu()'>üè† Kembali</button>`;
    }
  } catch(err){
    document.getElementById("output").innerHTML = `Terjadi kesalahan saat mencari buku.<br><button onclick='kembaliMenu()'>üè† Kembali</button>`;
    console.error(err);
  }
}

// ------------------- PREVIEW & CERITA -------------------
function previewBuku(judul, ringkasan) {
  document.getElementById("output").innerHTML = `
    <h2>${judul}</h2>
    <p>${ringkasan}</p>
    <button onclick="mulaiBercerita('${judul}', \`${ringkasan}\`)">‚ñ∂Ô∏è Mulai Bercerita</button>
    <button onclick="kembaliMenu()">üè† Kembali</button>
  `;
}

function pilihEfekSuara(ringkasan){
  let audioUrl = "";
  const text = ringkasan.toLowerCase();
  if(text.includes("binatang")) audioUrl = "https://www.soundjay.com/nature/sounds/birds-1.mp3";
  else if(text.includes("petualangan") || text.includes("perjalanan")) audioUrl = "https://www.soundjay.com/nature/sounds/wind-01.mp3";
  else if(text.includes("cerita rakyat") || text.includes("dongeng")) audioUrl = "https://www.soundjay.com/nature/sounds/water-flow-1.mp3";
  return audioUrl;
}

function mulaiBercerita(judul, ringkasan) {
  speechSynthesis.cancel();
  document.getElementById("output").innerHTML = `<h2>${judul}</h2><p>Buku sedang dibacakan...</p><button onclick="kembaliMenu()">üè† Kembali</button>`;
  
  // Musik latar umum
  const musik = new Audio("https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3");
  musik.volume = 0.15;
  musik.loop = true;
  musik.play();
  
  // Efek suara tema
  const efekUrl = pilihEfekSuara(ringkasan);
  let efekAudio;
  if(efekUrl){
    efekAudio = new Audio(efekUrl);
    efekAudio.volume = 0.2;
    efekAudio.loop = false;
    efekAudio.play();
  }

  // Text-to-Speech
  const utter = new SpeechSynthesisUtterance(ringkasan);
  utter.lang = 'id-ID';
  utter.rate = 0.9;
  utter.pitch = 1.2;
  utter.onend = ()=>{
    musik.pause(); musik.currentTime = 0;
    if(efekAudio) { efekAudio.pause(); efekAudio.currentTime = 0; }
  };
  speechSynthesis.speak(utter);
}

// ------------------- MULTI BUKU -------------------
function showDaftarBuku() {
  document.getElementById("menu").style.display="none";
  bukuQueue = [];
  document.getElementById("output").innerHTML = `
    <h2>Masukkan ISBN Buku</h2>
    <textarea id="isbnList" placeholder="Masukkan beberapa ISBN, satu per baris"></textarea><br>
    <button onclick="tambahQueue()">Tambahkan & Bercerita</button>
    <button onclick="kembaliMenu()">üè† Kembali</button>
  `;
}

function tambahQueue() {
  const list = document.getElementById("isbnList").value.trim().split("\n").map(l=>l.trim()).filter(l=>l);
  if(list.length===0){ alert("Masukkan minimal satu ISBN!"); return; }
  bukuQueue = list;
  bacaQueue(0);
}

function bacaQueue(index) {
  if(index >= bukuQueue.length){
    document.getElementById("progress").innerText = "Selesai membaca semua buku!";
    return;
  }
  const isbn = bukuQueue[index];
  document.getElementById("progress").innerText = `Sedang membaca buku ${index+1} dari ${bukuQueue.length}`;
  cariBukuOnlineMulti(isbn, ()=>bacaQueue(index+1));
}

async function cariBukuOnlineMulti(isbn, callback) {
  try {
    const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`);
    const data = await response.json();
    if(data.totalItems > 0){
      const info = data.items[0].volumeInfo;
      const judul = info.title || "Judul tidak tersedia";
      const pengarang = info.authors ? info.authors.join(", ") : "Pengarang tidak tersedia";
      const deskripsi = info.description || "Ringkasan buku tidak tersedia, AI akan menceritakan secara umum.";
      mulaiBerceritaMulti(`${judul} (oleh ${pengarang})`, deskripsi, callback);
    } else { callback(); }
  } catch(err){ console.error(err); callback(); }
}

function mulaiBerceritaMulti(judul, ringkasan, callback){
  speechSynthesis.cancel();
  const efekUrl = pilihEfekSuara(ringkasan);
  let efekAudio;
  if(efekUrl){
    efekAudio = new Audio(efekUrl);
    efekAudio.volume = 0.2;
    efekAudio.loop = false;
    efekAudio.play();
  }
  const utter = new SpeechSynthesisUtterance(ringkasan);
  utter.lang = 'id-ID';
  utter.rate = 0.9;
  utter.pitch = 1.2;
  utter.onend = ()=>{
    if(efekAudio) { efekAudio.pause(); efekAudio.currentTime = 0; }
    callback();
  };
  speechSynthesis.speak(utter);
}

// ------------------- KEMBALI KE MENU -------------------
function kembaliMenu() {
  speechSynthesis.cancel();
  document.getElementById("menu").style.display = "block";
  document.getElementById("output").innerHTML = "";
  document.getElementById("reader").innerHTML = "";
  document.getElementById("progress").innerText = "";
}
</script>

</body>
</html>
